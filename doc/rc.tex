%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Short Sectioned Assignment
% LaTeX Template
% Version 1.0 (5/5/12)
%
% This template has been downloaded from:
% http://www.LaTeXTemplates.com
%
% Original author:
% Frits Wenneker (http://www.howtotex.com)
%
% License:
% CC BY-NC-SA 3.0 (http://creativecommons.org/licenses/by-nc-sa/3.0/)
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%----------------------------------------------------------------------------------------
%	PACKAGES AND OTHER DOCUMENT CONFIGURATIONS
%----------------------------------------------------------------------------------------

\documentclass[paper=a4, fontsize=11pt]{scrartcl} % A4 paper and 11pt font size

\usepackage[T1]{fontenc} % Use 8-bit encoding that has 256 glyphs
\usepackage[english]{babel} % English language/hyphenation
\usepackage{amsmath,amsfonts,amsthm} % Math packages

\usepackage{lipsum} % Used for inserting dummy 'Lorem ipsum' text into the template

\usepackage{sectsty} % Allows customizing section commands
\allsectionsfont{\centering \normalfont\scshape} % Make all sections centered, the default font and small caps

\usepackage{fancyhdr} % Custom headers and footers
\usepackage{bm}
\usepackage{upgreek}
\usepackage{tikz}
\usepackage{tabulary}
\usepackage{multirow}
\usepackage{array}
\usepackage{adjustbox}
\usetikzlibrary{shapes.geometric}
\usetikzlibrary{positioning}
\usetikzlibrary{shapes, arrows}
\pagestyle{fancyplain} % Makes all pages in the document conform to the custom headers and footers
\fancyhead{} % No page header - if you want one, create it in the same way as the footers below
\fancyfoot[L]{} % Empty left footer
\fancyfoot[C]{} % Empty center footer
\fancyfoot[R]{\thepage} % Page numbering for right footer
\renewcommand{\headrulewidth}{0pt} % Remove header underlines
\renewcommand{\footrulewidth}{0pt} % Remove footer underlines
\setlength{\headheight}{13.6pt} % Customize the height of the header

%----------------------------------------------------------------------------------------
%	TITLE SECTION
%----------------------------------------------------------------------------------------

\newcommand{\horrule}[1]{\rule{\linewidth}{#1}} % Create horizontal rule command with 1 argument of height

\title{
\normalfont \normalsize
\textsc{MAGICC Lab - Brigham Young University} \\ [25pt] % Your university, school and/or department name(s)
\horrule{0.5pt} \\[0.4cm] % Thin top horizontal rule
\huge RC and Safety Pilot Integration \\ % The assignment title
\horrule{2pt} \\[0.5cm] % Thick bottom horizontal rule
}

\author{James Jackson} % Your name

\date{\normalsize\today} % Today's date or a custom date

\begin{document}

\maketitle % Print the title

%----------------------------------------------------------------------------------------
%	PROBLEM 1
%----------------------------------------------------------------------------------------

\section{Introduction}

A very important feature for ROSflight is the tight integration of an RC safety pilot.  The safety pilot is usually a highly experienced RC operator who is capable of knowing when the computer is doing something unsafe and taking over fast enough to land the MAV safely where researchers can fix the bugs and try again.  ROSflight can be used independently of an onboard computer similar to more fully-developed codes such as cleanflight and baseflight, however it is primarily designed to quickly test research code developed in ROS on hardware.  This means that we can assume that the controls coming from the onboard computer may be suspect, and may at any time try to make the MAV do something drastic, (such as full-throttle into the ceiling or full-power front flips).  While this may be exciting, it is often expensive and dangerous unless there is some safety pilot intervention.  The RC controls are designed to be first interpreted, then mixed with the onboard controls in a way that the safety pilot has quick access to correct dangerous maneuvers commanded by the onboard computer but is primarily on stand-by while the computer does it's thing with the hardware.

\begin{figure}[h!]
	\centering

	\tikzstyle{block} = [draw, rectangle, 
    					minimum height=3em, minimum width=6em]
  \tikzstyle{node}=[draw, ellipse, minimum size=3em,
    					align=center]
	\begin{tikzpicture}
		\node[block] (rc) {RC};
		\node[block, right=5em of rc] (offboard) {MAVlink};
		\node[node, below right=2.5em and 1.5em of rc] (mux) {mux};
		\node[block, below=2.5em of mux] (combined) {Composite};

		\draw[-triangle 60] (rc) -- (mux);
		\draw[-triangle 60] (offboard) -- (mux);
		\draw[-triangle 60] (mux) -- (combined);
	\end{tikzpicture}

	\label{mux_configuration}
	\caption{Diagram of how signals from RC and MAVlink are muxed in ROSflight}
\end{figure}

To do this, a command structure is created from both the incoming rc commands and commands over the mavlink serial line.  These structures are combined in the mux, as shown in figure~\ref{mux_configuration}.  This structure has four channels, which represent the four actuatable degrees of freedom on the MAV.  In general, the $x$ channel refers to roll, roll rate or aileron deflection, the $y$ channel to pitch, pitch rate or elevator deflection, the $z$ to yaw rate and rudder deflection and the $F$ channel to throttle.  

Each channel has three fields as shown in table~\ref{command_structure}.  The flag field refers to whether or not that particular channel is being controlled in this message.  If true, then the channel is active, and should be listened to.  If false, then it should be ignored.  If the message from both the offboard control and the RC are both inactive, then the RC signal is taken by default.  The type field indicates the type of information being carried by this channel.  For the $x$ and $y$ channels, this could be an angular rate in mrad/s, or an angle in mrad, the $z$ channel can carry only an angular rate in mrad/s and the $F$ channel can carry a throttle from 0-1000 or an altitude command in cm.  Each channel can also act in ``passthrough'' mode which means that the received PWM signal is forwarded directly to the mixer.  The value field is simply the data being carried in the channel.  This is interpreted according to the type field.

\begin{table}[h]
	\centering
	\caption{Command Structure}
	\label{command_structure}
	\begin{tabular}{| c | c |}
		\hline
		\multirow{3}{*} {$x$ channel}
			& flag \\ \cline{2-2}
			& type \\ \cline{2-2}
			& value \\ \hline
			\multirow{3}{*} {$y$ channel}
			& flag \\ \cline{2-2}
			& type \\ \cline{2-2}
			& value \\ \hline
			\multirow{3}{*} {$z$ channel}
			& flag \\ \cline{2-2}
			& type \\ \cline{2-2}
			& value \\ \hline
			\multirow{3}{*} {$F$ channel}
			& flag \\ \cline{2-2}
			& type \\ \cline{2-2}
			& value \\ \hline
	\end{tabular}
\end{table}

The logic of the mux is shown in figure~\ref{mux_logic}

\begin{figure}
\centering
	\tikzstyle{block} = [draw, rectangle, 
    					minimum height=3em, minimum width=6em, align=center]
  \tikzstyle{node}=[draw, ellipse, minimum size=3em,
    					align=center]
  \tikzstyle{dec}=[draw, diamond, aspect=2, align=center]
  \tikzstyle{coordinate}=[draw, none]
  \tikzstyle{a}=[-triangle 60]

  \begin{adjustbox}{max size={\textwidth}{\textheight}}
  \begin{tikzpicture}[scale=0.4]

  \node[node] (start) {start};
  \node[dec, below=2em of start] (time) {\footnotesize Has it been 20ms?};
  \node[node, right=2em of time] (done1) {done};
  \node[dec, below=1em of time] (fixed_wing) {Fixed Wing?};
  \node[dec, below left=2em and 4em of fixed_wing] (att_switch) {\footnotesize Att. Ctrl. Switch};
  \node[block, below right=2em and 4em of fixed_wing, text width = 11em] (pass) {\scriptsize x.type = PASSTHROUGH y.type = PASSTHROUGH z.type = PASSTHROUGH};
  \node [block, below left=2em and 2em of att_switch, text width = 7em] (angle) {\scriptsize x.type=ANGLE y.type=ANGLE};
  \node [block, below right=2em and 2em of att_switch, text width = 7em] (rate) {\scriptsize x.type=RATE y.type=RATE};
	\node [block, below=6em of att_switch, text width = 7em] (yaw_angle) {\scriptsize z.type=RATE};
	\node [dec, below=2em of yaw_angle] (f_switch) {\footnotesize F Ctrl. Switch};
	\node [block, below left=2em and 2em of f_switch] (F_alt) {\scriptsize F.type=ALTITUDE};
	\node [block, below right=2em and 2.5em of f_switch] (F_thr) {\scriptsize F.type=THROTTLE};

	\node [block, below=2em of F_thr] (convert) {Convert PWM to Rad};

	\node [dec, below=2em of convert] (att_over) {\scriptsize Att. override switch};

	\node [dec, below left=2em and 2em of att_over] (lag) {\scriptsize override stick lag};
	\node [dec, left=2em of lag] (deviated) {\scriptsize sticks deviated?};

	\node[block, below=10em of att_over, text width=6em] (xyz_active) {\scriptsize x.flag=ACTIVE y.flag=ACTIVE z.flag=ACTIVE};
	\node[block, below right=2em and 0em of deviated, text width = 6em] (set_lag) {\scriptsize set override stick lag};
	\node[block, below left=7em and 0em of deviated, text width=7em] (xyz_inactive) {\scriptsize x.flag=INACTIVE y.flag=INACTIVE z.flag=INACTIVE};

	\node[dec, below=2em of xyz_active, text width=6em] (thr_over) {\scriptsize Thr override switch};
	\node[block, below left=2em and 2em of thr_over] (f_inactive){\scriptsize F.flag=INACTIVE};
	\node[block, below right=2em and 2em of thr_over] (f_active){\scriptsize F.flag=ACTIVE};

	\node[node, below=4em of thr_over] (done2) {done};


	\draw[a] (start) -- (time);
	\draw[a] (time) -- node[above] {no} (done1);
	\draw[a] (time) -- node[left] {yes} (fixed_wing);
	\draw[a] (fixed_wing) -| node[above, pos=0.25] {yes} (pass);
	\draw[a] (fixed_wing) -| node[above, pos=0.25] {no} (att_switch);
	\draw[a] (att_switch) -| node[above, pos=0.25] {on} (angle);
	\draw[a] (att_switch) -| node[above, pos=0.25] {off} (rate);
	\draw[a] (rate) |- (yaw_angle);
	\draw[a] (angle) |- (yaw_angle);
	\draw[a] (yaw_angle) -- (f_switch);

	\coordinate[above=1em of f_switch] (f_switch_merge) {};
	\draw (pass) |- (f_switch_merge);

	\draw[a] (f_switch) -| node[above, pos=0.25]{off} (F_thr);
	\draw[a] (f_switch) -| node[above, pos=0.25]{on} (F_alt);
	\draw[a] (F_thr) -- (convert);
	\draw[a] (F_alt) |- (convert);

	\draw[a] (convert) -- (att_over);
	\draw[a] (att_over) -| node[above, pos=0.25] {no} (lag);
	\draw[a] (att_over) -- node[right] {yes} (xyz_active);

	\draw[a] (lag) -- node[above] {no} (deviated);
	\coordinate[below=2em of att_over] (over_merge1);
	\draw (lag) -- node[above] {yes} (over_merge1);
	\draw[a] (deviated) |- node[left, pos=0.25] {yes} (set_lag);
	\draw[a] (deviated) -| node[above, pos=0.25] {no} (xyz_inactive);
	\coordinate[right=8.7em of set_lag] (over_merge2);
	\draw (set_lag) -- (over_merge2);

	\coordinate[above=1em of thr_over] (thr_merge);
	\draw (xyz_inactive) |- (thr_merge);
	\draw[a] (xyz_active) -- (thr_over);

	\draw[a] (thr_over) -| node[above, pos=0.25] {off} (f_inactive);
	\draw[a] (thr_over) -| node[above, pos=0.25] {on} (f_active);

	\draw[a] (f_inactive) |- (done2);
	\draw[a] (f_active) |- (done2);

  \end{tikzpicture}
  \end{adjustbox}

	

\end{figure}







\end{document}
