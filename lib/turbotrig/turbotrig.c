/*
 *
 * BSD 3-Clause License
 *
 * Copyright (c) 2017, James Jackson - BYU MAGICC Lab, Provo UT
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are met:
 *
 * * Redistributions of source code must retain the above copyright notice, this
 *   list of conditions and the following disclaimer.
 *
 * * Redistributions in binary form must reproduce the above copyright notice,
 *   this list of conditions and the following disclaimer in the documentation
 *   and/or other materials provided with the distribution.
 *
 * * Neither the name of the copyright holder nor the names of its
 *   contributors may be used to endorse or promote products derived from
 *   this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
 * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
 * DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE
 * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
 * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
 * SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER
 * CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
 * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

#ifdef __cplusplus
extern "C" {
#endif
#include <turbotrig/turbotrig.h>

#ifndef M_PI
#define M_PI 3.14159265359
#endif

static const float atan_max_x = 1.000000;
static const float atan_min_x = 0.000000;
static const int16_t atan_num_entries = 500;
static const float atan_scale_factor = 10000.000000;
static const int16_t atan_lookup_table[500] = {
0,	20,	40,	60,	80,	100,	120,	140,	160,	180,
200,	220,	240,	260,	280,	300,	320,	340,	360,	380,
400,	420,	440,	460,	480,	500,	520,	539,	559,	579,
599,	619,	639,	659,	679,	699,	719,	739,	759,	778,
798,	818,	838,	858,	878,	898,	917,	937,	957,	977,
997,	1016,	1036,	1056,	1076,	1096,	1115,	1135,	1155,	1175,
1194,	1214,	1234,	1253,	1273,	1293,	1312,	1332,	1352,	1371,
1391,	1411,	1430,	1450,	1469,	1489,	1508,	1528,	1548,	1567,
1587,	1606,	1626,	1645,	1664,	1684,	1703,	1723,	1742,	1762,
1781,	1800,	1820,	1839,	1858,	1878,	1897,	1916,	1935,	1955,
1974,	1993,	2012,	2032,	2051,	2070,	2089,	2108,	2127,	2146,
2166,	2185,	2204,	2223,	2242,	2261,	2280,	2299,	2318,	2337,
2355,	2374,	2393,	2412,	2431,	2450,	2469,	2487,	2506,	2525,
2544,	2562,	2581,	2600,	2618,	2637,	2656,	2674,	2693,	2712,
2730,	2749,	2767,	2786,	2804,	2823,	2841,	2859,	2878,	2896,
2915,	2933,	2951,	2970,	2988,	3006,	3024,	3043,	3061,	3079,
3097,	3115,	3133,	3151,	3169,	3187,	3206,	3224,	3241,	3259,
3277,	3295,	3313,	3331,	3349,	3367,	3385,	3402,	3420,	3438,
3456,	3473,	3491,	3509,	3526,	3544,	3561,	3579,	3596,	3614,
3631,	3649,	3666,	3684,	3701,	3719,	3736,	3753,	3771,	3788,
3805,	3822,	3839,	3857,	3874,	3891,	3908,	3925,	3942,	3959,
3976,	3993,	4010,	4027,	4044,	4061,	4078,	4095,	4112,	4128,
4145,	4162,	4179,	4195,	4212,	4229,	4245,	4262,	4278,	4295,
4311,	4328,	4344,	4361,	4377,	4394,	4410,	4426,	4443,	4459,
4475,	4491,	4508,	4524,	4540,	4556,	4572,	4588,	4604,	4620,
4636,	4652,	4668,	4684,	4700,	4716,	4732,	4748,	4764,	4779,
4795,	4811,	4827,	4842,	4858,	4874,	4889,	4905,	4920,	4936,
4951,	4967,	4982,	4998,	5013,	5028,	5044,	5059,	5074,	5090,
5105,	5120,	5135,	5150,	5166,	5181,	5196,	5211,	5226,	5241,
5256,	5271,	5286,	5301,	5315,	5330,	5345,	5360,	5375,	5389,
5404,	5419,	5434,	5448,	5463,	5477,	5492,	5507,	5521,	5535,
5550,	5564,	5579,	5593,	5608,	5622,	5636,	5650,	5665,	5679,
5693,	5707,	5721,	5736,	5750,	5764,	5778,	5792,	5806,	5820,
5834,	5848,	5862,	5875,	5889,	5903,	5917,	5931,	5944,	5958,
5972,	5985,	5999,	6013,	6026,	6040,	6053,	6067,	6080,	6094,
6107,	6121,	6134,	6147,	6161,	6174,	6187,	6201,	6214,	6227,
6240,	6253,	6267,	6280,	6293,	6306,	6319,	6332,	6345,	6358,
6371,	6384,	6397,	6409,	6422,	6435,	6448,	6461,	6473,	6486,
6499,	6511,	6524,	6537,	6549,	6562,	6574,	6587,	6599,	6612,
6624,	6637,	6649,	6661,	6674,	6686,	6698,	6711,	6723,	6735,
6747,	6760,	6772,	6784,	6796,	6808,	6820,	6832,	6844,	6856,
6868,	6880,	6892,	6904,	6916,	6928,	6940,	6951,	6963,	6975,
6987,	6998,	7010,	7022,	7033,	7045,	7057,	7068,	7080,	7091,
7103,	7114,	7126,	7137,	7149,	7160,	7171,	7183,	7194,	7205,
7217,	7228,	7239,	7250,	7261,	7273,	7284,	7295,	7306,	7317,
7328,	7339,	7350,	7361,	7372,	7383,	7394,	7405,	7416,	7427,
7438,	7448,	7459,	7470,	7481,	7491,	7502,	7513,	7524,	7534,
7545,	7555,	7566,	7577,	7587,	7598,	7608,	7619,	7629,	7640,
7650,	7660,	7671,	7681,	7691,	7702,	7712,	7722,	7733,	7743,
7753,	7763,	7773,	7783,	7794,	7804,	7814,	7824,	7834,	7844,
};

int16_t asin_lookup_table[1001] =
{
  0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22,
  23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43,
  44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64,
  65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 77, 78, 79, 80, 81, 82, 83, 84, 85,
  86, 87, 88, 89, 90, 91, 92, 93, 94, 95, 96, 97, 98, 99, 100, 101, 102, 103, 104, 105,
  106, 107, 108, 109, 110, 111, 112, 113, 114, 115, 116, 117, 118, 119, 120, 121, 122,
  123, 124, 125, 126, 127, 128, 129, 130, 131, 132, 133, 134, 135, 136, 137, 138, 139,
  140, 141, 142, 143, 144, 145, 146, 147, 148, 149, 150, 151, 152, 153, 154, 155, 156,
  157, 158, 159, 160, 161, 162, 163, 164, 165, 166, 167, 168, 169, 170, 171, 172, 173,
  174, 175, 176, 177, 178, 179, 180, 182, 183, 184, 185, 186, 187, 188, 189, 190, 191,
  192, 193, 194, 195, 196, 197, 198, 199, 200, 201, 202, 203, 204, 205, 206, 207, 208,
  209, 210, 211, 212, 213, 214, 215, 216, 217, 218, 219, 220, 221, 222, 223, 224, 225,
  226, 227, 228, 230, 231, 232, 233, 234, 235, 236, 237, 238, 239, 240, 241, 242, 243,
  244, 245, 246, 247, 248, 249, 250, 251, 252, 253, 254, 255, 256, 257, 258, 259, 260,
  261, 263, 264, 265, 266, 267, 268, 269, 270, 271, 272, 273, 274, 275, 276, 277, 278,
  279, 280, 281, 282, 283, 284, 285, 286, 287, 289, 290, 291, 292, 293, 294, 295, 296,
  297, 298, 299, 300, 301, 302, 303, 304, 305, 306, 307, 308, 309, 310, 312, 313, 314,
  315, 316, 317, 318, 319, 320, 321, 322, 323, 324, 325, 326, 327, 328, 329, 331, 332,
  333, 334, 335, 336, 337, 338, 339, 340, 341, 342, 343, 344, 345, 346, 347, 349, 350,
  351, 352, 353, 354, 355, 356, 357, 358, 359, 360, 361, 362, 363, 365, 366, 367, 368,
  369, 370, 371, 372, 373, 374, 375, 376, 377, 379, 380, 381, 382, 383, 384, 385, 386,
  387, 388, 389, 390, 391, 393, 394, 395, 396, 397, 398, 399, 400, 401, 402, 403, 404,
  406, 407, 408, 409, 410, 411, 412, 413, 414, 415, 416, 418, 419, 420, 421, 422, 423,
  424, 425, 426, 427, 429, 430, 431, 432, 433, 434, 435, 436, 437, 438, 440, 441, 442,
  443, 444, 445, 446, 447, 448, 450, 451, 452, 453, 454, 455, 456, 457, 458, 460, 461,
  462, 463, 464, 465, 466, 467, 469, 470, 471, 472, 473, 474, 475, 476, 477, 479, 480,
  481, 482, 483, 484, 485, 487, 488, 489, 490, 491, 492, 493, 494, 496, 497, 498, 499,
  500, 501, 502, 504, 505, 506, 507, 508, 509, 510, 512, 513, 514, 515, 516, 517, 518,
  520, 521, 522, 523, 524, 525, 527, 528, 529, 530, 531, 532, 534, 535, 536, 537, 538,
  539, 541, 542, 543, 544, 545, 546, 548, 549, 550, 551, 552, 553, 555, 556, 557, 558,
  559, 560, 562, 563, 564, 565, 566, 568, 569, 570, 571, 572, 574, 575, 576, 577, 578,
  579, 581, 582, 583, 584, 585, 587, 588, 589, 590, 591, 593, 594, 595, 596, 598, 599,
  600, 601, 602, 604, 605, 606, 607, 608, 610, 611, 612, 613, 615, 616, 617, 618, 619,
  621, 622, 623, 624, 626, 627, 628, 629, 631, 632, 633, 634, 636, 637, 638, 639, 641,
  642, 643, 644, 646, 647, 648, 649, 651, 652, 653, 654, 656, 657, 658, 659, 661, 662,
  663, 664, 666, 667, 668, 670, 671, 672, 673, 675, 676, 677, 678, 680, 681, 682, 684,
  685, 686, 688, 689, 690, 691, 693, 694, 695, 697, 698, 699, 701, 702, 703, 704, 706,
  707, 708, 710, 711, 712, 714, 715, 716, 718, 719, 720, 722, 723, 724, 726, 727, 728,
  730, 731, 732, 734, 735, 736, 738, 739, 740, 742, 743, 745, 746, 747, 749, 750, 751,
  753, 754, 755, 757, 758, 760, 761, 762, 764, 765, 767, 768, 769, 771, 772, 773, 775,
  776, 778, 779, 781, 782, 783, 785, 786, 788, 789, 790, 792, 793, 795, 796, 798, 799,
  800, 802, 803, 805, 806, 808, 809, 811, 812, 813, 815, 816, 818, 819, 821, 822, 824,
  825, 827, 828, 830, 831, 833, 834, 836, 837, 839, 840, 842, 843, 845, 846, 848, 849,
  851, 852, 854, 855, 857, 858, 860, 861, 863, 864, 866, 867, 869, 871, 872, 874, 875,
  877, 878, 880, 881, 883, 885, 886, 888, 889, 891, 893, 894, 896, 897, 899, 901, 902,
  904, 905, 907, 909, 910, 912, 914, 915, 917, 919, 920, 922, 923, 925, 927, 928, 930,
  932, 933, 935, 937, 939, 940, 942, 944, 945, 947, 949, 951, 952, 954, 956, 957, 959,
  961, 963, 964, 966, 968, 970, 971, 973, 975, 977, 979, 980, 982, 984, 986, 988, 989,
  991, 993, 995, 997, 999, 1000, 1002, 1004, 1006, 1008, 1010, 1012, 1014, 1015, 1017,
  1019, 1021, 1023, 1025, 1027, 1029, 1031, 1033, 1035, 1037, 1039, 1041, 1043, 1045,
  1047, 1049, 1051, 1053, 1055, 1057, 1059, 1061, 1063, 1065, 1067, 1069, 1071, 1073,
  1075, 1077, 1080, 1082, 1084, 1086, 1088, 1090, 1092, 1095, 1097, 1099, 1101, 1103,
  1106, 1108, 1110, 1112, 1115, 1117, 1119, 1122, 1124, 1126, 1129, 1131, 1133, 1136,
  1138, 1140, 1143, 1145, 1148, 1150, 1153, 1155, 1157, 1160, 1163, 1165, 1168, 1170,
  1173, 1175, 1178, 1181, 1183, 1186, 1189, 1191, 1194, 1197, 1199, 1202, 1205, 1208,
  1211, 1213, 1216, 1219, 1222, 1225, 1228, 1231, 1234, 1237, 1240, 1243, 1246, 1250,
  1253, 1256, 1259, 1262, 1266, 1269, 1273, 1276, 1279, 1283, 1287, 1290, 1294, 1297,
  1301, 1305, 1309, 1313, 1317, 1321, 1325, 1329, 1333, 1337, 1342, 1346, 1351, 1355,
  1360, 1365, 1370, 1375, 1380, 1386, 1391, 1397, 1403, 1409, 1415, 1422, 1429, 1436,
  1444, 1452, 1461, 1470, 1481, 1493, 1507, 1526, 1571
};


int32_t sign(int32_t y)
{
  return (0 < y) - (y < 0);
}

float fsign(float y)
{
  return (0.0 < y) - (y < 0.0);
}

float asin_approx(float x)
{
  int32_t x_int = (int32_t)(1000*x);
  float out = ((float)turboasin(x_int))/1000.0f;
  return out;
}


float turboatan(float x)
{
  // atan is symmetric
  if (x < 0)
  {
    return -1.0*turboatan(-1.0*x);
  }
  // This uses a sweet identity to wrap the domain of atan onto (0,1)
  if (x > 1.0)
  {
    return M_PI/2.0 - turboatan(1.0/x);
  }

  float t = (x - atan_min_x)/(float)(atan_max_x - atan_min_x) * (float)atan_num_entries;
  int16_t index = (int)t;
  float dx = t - index;

  if (index >= atan_num_entries)
      return atan_lookup_table[atan_num_entries-1]/atan_scale_factor;
  else if (index < atan_num_entries - 1)
      return atan_lookup_table[index]/atan_scale_factor + dx * (atan_lookup_table[index + 1] - atan_lookup_table[index])/atan_scale_factor;
  else
      return atan_lookup_table[index]/atan_scale_factor + dx * (atan_lookup_table[index] - atan_lookup_table[index - 1])/atan_scale_factor;
}


float atan2_approx(float y, float x)
{
  // algorithm from wikipedia: https://en.wikipedia.org/wiki/Atan2
  if (x == 0.0)
  {
    if (y < 0.0)
    {
      return - M_PI/2.0;
    }
    else if ( y > 0.0)
    {
      return M_PI/2.0;
    }
    else
    {
      return 0.0;
    }
  }

  float arctan = turboatan(y/x);

  if (x < 0.0)
  {
    if ( y < 0)
    {
      return arctan - M_PI;
    }
    else
    {
      return arctan + M_PI;
    }
  }

  else
  {
      return arctan;
  }
}


int32_t turboatan_taylor(int32_t x)
{
  if (x > 1000)
  {
    return 1571-turboatan(1000000/x);
  }

  return (972*x/1000) - (((191*x*x)/1000)*x)/(1000*1000); // the weird order of operations is to prevent overflow
}


int32_t turbocos(int32_t x)
{
  return turbosin(x + 1571);
}


int32_t turbosin(int32_t x)
{
  // wrap to +/- PI
  if (x < -3142)
    x += 6283;
  else if (x >  3142)
    x -= 6283;

  if (x < 0)
  {
    return (1273 * x)/1000 + (405 * x * x)/(1000000);
  }
  else
  {
    return (1273 * x)/1000 - (405 * x * x)/(1000000);
  }

  return x;
}


int32_t turboasin(int32_t x)
{
  if (x < 0)
  {
    return -1*turboasin(-1*x);
  }
  else if (x > 999)
  {
    return asin_lookup_table[1000];
  }
  return asin_lookup_table[x];
}
#ifdef __cplusplus
}
#endif
